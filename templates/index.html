<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>YOLO Detection - 2 камеры</title>
</head>
<body>
    <h1>YOLO Person Detection - Две камеры</h1>

    <div>
        <h2>Камера 1</h2>
        <label>Выбрать:</label>
        <select id="cameraSelect1">
            <option value="">Загрузка...</option>
        </select>
        <button onclick="changeCamera(1)">Применить</button>
        <br>
        <img id="videoStream1" src="/api/video/feed1" width="640" height="480">
    </div>

    <div>
        <h2>Камера 2</h2>
        <label>Выбрать:</label>
        <select id="cameraSelect2">
            <option value="">Загрузка...</option>
        </select>
        <button onclick="changeCamera(2)">Применить</button>
        <br>
        <img id="videoStream2" src="/api/video/feed2" width="640" height="480">
    </div>

    <div>
        <h2>Координаты смещения</h2>
        <input type="number" id="coordX" placeholder="X">
        <input type="number" id="coordY" placeholder="Y">
        <button onclick="sendCoordinates()">Отправить</button>
    </div>

    <p id="status"></p>

    <script>
        async function loadCameras() {
            try {
                const res = await fetch('/api/video/cameras');
                const cameras = await res.json();
                console.log('Доступные камеры:', cameras);

                const select1 = document.getElementById('cameraSelect1');
                const select2 = document.getElementById('cameraSelect2');

                select1.innerHTML = '';
                select2.innerHTML = '';

                cameras.forEach(cam => {
                    const option1 = document.createElement('option');
                    option1.value = cam.id;
                    option1.textContent = cam.name;
                    select1.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = cam.id;
                    option2.textContent = cam.name;
                    select2.appendChild(option2);
                });

                if (cameras.length > 1) {
                    select2.value = cameras[1].id;
                }
            } catch (error) {
                console.error('Ошибка загрузки камер:', error);
            }
        }

        async function changeCamera(cameraNum) {
            const selectId = `cameraSelect${cameraNum}`;
            const cameraId = document.getElementById(selectId).value;

            console.log(`Меняем камеру ${cameraNum} на ID ${cameraId}`);

            if (!cameraId) {
                alert('Выберите камеру');
                return;
            }

            try {
                const res = await fetch(`/api/video/select_camera/${cameraNum}/${cameraId}`, {
                    method: 'POST'
                });
                const data = await res.json();
                console.log('Ответ сервера:', data);

                const videoStreamId = `videoStream${cameraNum}`;
                document.getElementById(videoStreamId).src =
                    `/api/video/feed${cameraNum}?time=${Date.now()}`;
            } catch (error) {
                console.error('Ошибка смены камеры:', error);
            }
        }

        async function sendCoordinates() {
            const x = document.getElementById('coordX').value;
            const y = document.getElementById('coordY').value;

            if (!x || !y) {
                document.getElementById('status').textContent = 'Введите X и Y';
                return;
            }

            try {
                const res = await fetch('/api/coords/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({x: parseInt(x), y: parseInt(y)})
                });

                const data = await res.json();
                document.getElementById('status').textContent =
                    `Исходные: X=${data.original.x}, Y=${data.original.y}. Смещение: X=${data.modified.x}, Y=${data.modified.y}`;
            } catch (error) {
                console.error('Ошибка отправки:', error);
            }
        }

        window.onload = loadCameras;
    </script>
</body>
</html>
